name: Java CI/CD with EC2 Git Pull Deploy

on:
  push:
    branches:
      - main

jobs:
  git-pull-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: âœ… SSH into EC2, pull latest code, build, and restart app
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        script: |
          echo "ğŸ‘‰ [1] Move to backend project folder"
          cd ~/backend

          echo "ğŸ”„ [2] Git pull latest code"
          git reset --hard HEAD
          git pull origin main

          echo "ğŸ§¹ [3] Kill existing app (port 8080)"
          pid=$(lsof -t -i:8080)
          if [ -n "$pid" ]; then
            kill -9 $pid
          else
            echo "No app running on port 8080."
          fi

          echo "âš™ï¸ [4] Grant execute permission to gradlew"
          chmod +x ./gradlew

          echo "ğŸ› ï¸ [5] Build project (including tests)"
          ./gradlew clean build -x test

          echo "ğŸš€ [6] Start new Spring Boot app"
          export $(cat .env | xargs)
          nohup java -jar build/libs/innervoice-0.0.1-SNAPSHOT.jar \
            --spring.profiles.active=dev > nohup.out 2>&1 &

          echo "ğŸ“„ [7] Check nohup output (last 30 lines)"
          tail -n 30 nohup.out
