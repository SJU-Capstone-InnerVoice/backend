name: Java CI/CD with EC2 Deploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ✅ Checkout code (with full history)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ☕ Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ⚙️ Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: 🛠️ Grant execute permission to gradlew
      run: chmod +x ./gradlew

    - name: 🧹 Clean and build (no tests)
      run: ./gradlew clean build -x test

    - name: 🧨 Remove old JAR on EC2
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        script: |
          echo "Removing old JAR..."
          rm -f ~/backend/build/libs/innervoice-0.0.1-SNAPSHOT.jar

    - name: 🚚 Copy JAR to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        source: "build/libs/innervoice-0.0.1-SNAPSHOT.jar"
        target: "/home/ec2-user/backend/build/libs/"

    - name: 🔫 Kill existing app on EC2 (port-based)
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        script: |
          echo "Killing existing app (port 8080)..."
          pid=$(lsof -t -i:8080)
          if [ -n "$pid" ]; then
            echo "Found process $pid. Killing..."
            kill -9 $pid
          else
            echo "No process running on port 8080."
          fi

    - name: 🚀 Start new app on EC2
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        script: |
          echo "Exporting env vars..."
          export $(cat ~/backend/.env | xargs)

          echo "Starting app..."
          nohup java -jar ~/backend/build/libs/innervoice-0.0.1-SNAPSHOT.jar \
            --spring.profiles.active=dev > ~/backend/nohup.out 2>&1 &

    - name: 📄 Check app logs (last 30 lines)
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        script: tail -n 30 ~/backend/nohup.out
