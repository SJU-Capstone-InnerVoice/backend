name: Deploy Spring Boot to EC2 (Git ë°©ì‹)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: EC2ì— SSH ì ‘ì†í•˜ì—¬ ì•± ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script_stop: true
          script: |
            echo "âœ… EC2 ì ‘ì† ì„±ê³µ. ë°°í¬ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤..."

            # 1. í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/ec2-user/backend

            # 2. Git ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git pull origin main

            # 3. ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ (í¬íŠ¸ 8080 ì‚¬ìš© ì¤‘ì´ë©´ kill)
            PID=$(lsof -t -i:8080)
            if [ -n "$PID" ]; then
              echo "ðŸ” ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì¤‘: $PID"
              kill -9 $PID
            fi

            # 4. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
            ./gradlew clean build -x test

            # 5. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œ, docker profile ì ìš©)
            echo "ðŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì¤‘..."
            nohup java -Dspring.profiles.active=docker -jar build/libs/*SNAPSHOT.jar > output.log 2>&1 &
