name: Deploy Spring Boot to EC2 

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¡ EC2ì— SSHë¡œ ì ‘ì†í•˜ì—¬ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì´ë™ ë° ì½”ë“œ pull
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script_stop: true
          script: |
            echo "âœ… EC2 ì ‘ì† ì„±ê³µ"

            cd /home/ec2-user/backend
            git pull origin main

      - name: ðŸ›‘ ì‹¤í–‰ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ (í¬íŠ¸ 8080)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            PID=$(lsof -t -i:8080)
            if [ -n "$PID" ]; then
              echo "ðŸ” ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤ (PID: $PID)"
              kill -9 $PID
            else
              echo "ðŸ” ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤"
            fi

      - name: ðŸ§¹ gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ + ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd /home/ec2-user/backend

            # âœ… JAVA_HOME ì„¤ì •
            echo 'export JAVA_HOME=/usr/lib/jvm/java-17-amazon-corretto.x86_64' >> ~/.bashrc
            echo 'export PATH=$JAVA_HOME/bin:$PATH' >> ~/.bashrc
            source ~/.bashrc
            
            chmod +x ./gradlew
            ./gradlew clean build -x test

      - name: ðŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (docker profile ì ìš©)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd /home/ec2-user/backend
            echo "ðŸš€ ë°±ê·¸ë¼ìš´ë“œë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•©ë‹ˆë‹¤"
            nohup java -Dspring.profiles.active=docker -jar build/libs/*SNAPSHOT.jar > output.log 2>&1 &
